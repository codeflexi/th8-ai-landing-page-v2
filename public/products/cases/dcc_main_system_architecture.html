<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH8 System Architecture & Implementation Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        /* Flow Lines */
        .pipeline-connector {
            position: absolute;
            left: 2rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #3b82f6 0%, #06b6d4 50%, #10b981 100%);
            z-index: 0;
        }

        /* Card Hover Effects */
        .tech-card { transition: all 0.3s ease; border: 1px solid #334155; }
        .tech-card:hover { transform: translateX(10px); border-color: #38bdf8; box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); }
        
        /* Code Block Styling */
        .code-block { background: #1e1e1e; border-left: 4px solid #f59e0b; }
    </style>
</head>
<body class="antialiased min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-slate-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">TH8 <span class="text-cyan-400">Architecture</span></h1>
                <p class="text-xs text-slate-400 mono">Hybrid Neuro-Symbolic Audit System</p>
            </div>
            <div class="flex space-x-2 text-xs font-bold">
                <span class="px-2 py-1 bg-blue-900 text-blue-300 rounded">Rule-Based</span>
                <span class="px-2 py-1 bg-purple-900 text-purple-300 rounded">LLM Engine</span>
                <span class="px-2 py-1 bg-emerald-900 text-emerald-300 rounded">Human-in-Loop</span>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-6 py-12 relative">
        <!-- Vertical Line -->
        <div class="pipeline-connector hidden md:block"></div>

        <!-- STEP 1: INGESTION -->
        <div class="relative pl-0 md:pl-16 mb-16">
            <div class="absolute left-2 top-0 w-12 h-12 bg-slate-900 border-2 border-blue-500 rounded-full items-center justify-center z-10 hidden md:flex font-bold text-blue-500">01</div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Concept -->
                <div>
                    <h2 class="text-xl font-bold text-blue-400 mb-2">Data Ingestion & Context Engineering</h2>
                    <p class="text-slate-400 text-sm mb-4">
                        ดึงข้อมูล Raw Data จาก ERP และ "เตรียมบริบท" ให้ AI เข้าใจ (Contextualization)
                    </p>
                    <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                        <h4 class="text-xs font-bold text-slate-300 uppercase mb-2">Tech Stack</h4>
                        <ul class="text-sm space-y-1 text-slate-400">
                            <li>• <span class="text-white">Airflow/Kafka:</span> ETL Pipeline</li>
                            <li>• <span class="text-white">OCR (Tesseract/Google Vision):</span> อ่าน Invoice ภาษาไทย</li>
                            <li>• <span class="text-white">Vector DB (Pinecone):</span> เก็บประวัติสินค้า (Embeddings)</li>
                        </ul>
                    </div>
                </div>
                <!-- Implementation Code -->
                <div class="code-block p-4 rounded-lg font-mono text-xs overflow-x-auto text-gray-300">
<span class="text-purple-400">def</span> <span class="text-yellow-300">build_context</span>(po_data):
    <span class="text-gray-500"># 1. Fetch Contract Price (The Truth)</span>
    contract = db.get_contract(item_id=po_data.item_id)
    
    <span class="text-gray-500"># 2. Vector Search for similar past items</span>
    <span class="text-gray-500"># (e.g., "A4 Paper" vs "Paper A4 80gsm")</span>
    history = vector_db.similarity_search(po_data.description)
    
    <span class="text-gray-500"># 3. Construct Context Object</span>
    context = {
        <span class="text-green-400">"current_po"</span>: po_data,
        <span class="text-green-400">"contract_rate"</span>: contract.price,
        <span class="text-green-400">"vendor_reliability"</span>: vendor_score(po_data.vendor_id),
        <span class="text-green-400">"thai_tax_rules"</span>: <span class="text-green-400">"WHT 3% for Services"</span>
    }
    <span class="text-purple-400">return</span> context
                </div>
            </div>
        </div>

        <!-- STEP 2: HYBRID ENGINE -->
        <div class="relative pl-0 md:pl-16 mb-16">
            <div class="absolute left-2 top-0 w-12 h-12 bg-slate-900 border-2 border-purple-500 rounded-full items-center justify-center z-10 hidden md:flex font-bold text-purple-500">02</div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Concept -->
                <div>
                    <h2 class="text-xl font-bold text-purple-400 mb-2">The Hybrid Engine (Rule + LLM)</h2>
                    <p class="text-slate-400 text-sm mb-4">
                        หัวใจสำคัญคือการใช้ Rules กรองสิ่งที่ชัดเจนก่อน แล้วส่งสิ่งที่ "คลุมเครือ" ให้ LLM ตัดสิน
                    </p>
                    
                    <div class="space-y-3">
                        <div class="tech-card bg-slate-800 p-3 rounded-md">
                            <span class="text-xs font-bold text-blue-300 block mb-1">Layer 1: Hard Rules (SQL/Python)</span>
                            <p class="text-xs text-slate-500">ตรวจสอบตรรกะตายตัว: ราคาเกิน Contract? PO แตกยอดภายใน 5 นาที? (เร็ว แม่นยำ 100%)</p>
                        </div>
                        <div class="tech-card bg-slate-800 p-3 rounded-md border-l-4 border-l-purple-500">
                            <span class="text-xs font-bold text-purple-300 block mb-1">Layer 2: LLM Reasoning (Gemini/GPT)</span>
                            <p class="text-xs text-slate-500">ตรวจสอบ Semantic: "ค่าบริการทำความสะอาด" ถือเป็น Service หรือ Goods? (เพื่อคำนวณ WHT)</p>
                        </div>
                    </div>
                </div>
                <!-- Implementation Code -->
                <div class="code-block p-4 rounded-lg font-mono text-xs overflow-x-auto text-gray-300">
<span class="text-gray-500"># Workflow: Rule First, then LLM</span>

<span class="text-purple-400">if</span> rule_engine.check_split_po(po_list):
    flag_fraud(<span class="text-green-400">"High Confidence: Split PO Detected"</span>)

<span class="text-purple-400">elif</span> price_variance > 0:
    <span class="text-gray-500"># Send to LLM to understand WHY</span>
    prompt = f"""
    Item: {item_desc}
    Contract Price: {contract_price}
    Actual Price: {actual_price}
    Vendor Note: {vendor_remark}
    
    Is this variance justified? (e.g. Urgent delivery surcharge?)
    Answer JSON: {{ "justified": bool, "reason": str }}
    """
    ai_verdict = llm.generate(prompt)
                </div>
            </div>
        </div>

        <!-- STEP 3: UI & ACTION -->
        <div class="relative pl-0 md:pl-16 mb-16">
            <div class="absolute left-2 top-0 w-12 h-12 bg-slate-900 border-2 border-amber-500 rounded-full items-center justify-center z-10 hidden md:flex font-bold text-amber-500">03</div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Concept -->
                <div>
                    <h2 class="text-xl font-bold text-amber-400 mb-2">UI & Human-in-the-Loop</h2>
                    <p class="text-slate-400 text-sm mb-4">
                        User Interface ไม่ใช่แค่ Dashboard แต่เป็น "Control Center" เพื่อกด Action (Approve/Block)
                    </p>
                    <div class="bg-amber-900/20 p-4 rounded-lg border border-amber-500/30">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-amber-400 font-bold text-sm">⚠️ Anomaly Card</span>
                            <span class="text-xs text-amber-200 bg-amber-800 px-2 rounded">Confidence: 92%</span>
                        </div>
                        <p class="text-xs text-slate-300 mb-3">
                            AI พบความเสี่ยง: <strong class="text-white">Duplicate Invoice</strong><br>
                            Inv #A001 และ #A001-Re มียอดเท่ากัน เวลาใกล้กัน
                        </p>
                        <div class="flex space-x-2">
                            <button class="bg-red-600 text-white text-xs px-3 py-1 rounded hover:bg-red-500">Block Payment</button>
                            <button class="bg-slate-600 text-white text-xs px-3 py-1 rounded hover:bg-slate-500">Ignore</button>
                        </div>
                    </div>
                </div>
                <!-- Implementation Code -->
                <div class="code-block p-4 rounded-lg font-mono text-xs overflow-x-auto text-gray-300">
<span class="text-gray-500">// Frontend: React / Next.js Action</span>

<span class="text-purple-400">const</span> handleBlock = <span class="text-purple-400">async</span> (anomalyId) => {
  <span class="text-gray-500">// 1. Update UI State</span>
  setStatus(<span class="text-green-400">"Blocking..."</span>);

  <span class="text-gray-500">// 2. Call API to ERP (SAP/Oracle)</span>
  <span class="text-purple-400">await</span> api.post(<span class="text-green-400">"/erp/hold-payment"</span>, {
    invoice_id: anomalyId,
    reason: <span class="text-green-400">"TH8_AI_DETECTED_DUPLICATE"</span>
  });

  <span class="text-gray-500">// 3. Log Action for Audit</span>
  logAction({
    user: currentUser,
    action: <span class="text-green-400">"BLOCK"</span>,
    timestamp: <span class="text-purple-400">new</span> Date()
  });
};
                </div>
            </div>
        </div>

        <!-- STEP 4: LOGGING & P&L -->
        <div class="relative pl-0 md:pl-16">
            <div class="absolute left-2 top-0 w-12 h-12 bg-slate-900 border-2 border-emerald-500 rounded-full items-center justify-center z-10 hidden md:flex font-bold text-emerald-500">04</div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Concept -->
                <div>
                    <h2 class="text-xl font-bold text-emerald-400 mb-2">Immutable Logs & P&L Impact</h2>
                    <p class="text-slate-400 text-sm mb-4">
                        ทุก Action ต้องถูกบันทึก (Audit Trail) และคำนวณกลับเป็นตัวเงิน (Realized Savings)
                    </p>
                    <ul class="text-sm space-y-2 text-slate-400">
                        <li class="flex items-center"><span class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span> Database: PostgreSQL (Transactions) + MongoDB (Logs)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span> Dashboard: คำนวณ "Cost Avoidance" แบบ Real-time</li>
                    </ul>
                </div>
                <!-- Implementation Code -->
                <div class="code-block p-4 rounded-lg font-mono text-xs overflow-x-auto text-gray-300">
<span class="text-gray-500">-- SQL: Calculating Savings for P&L Dashboard</span>

<span class="text-purple-400">SELECT</span> 
    SUM(amount) <span class="text-purple-400">AS</span> total_savings_thb,
    leakage_type
<span class="text-purple-400">FROM</span> th8_audit_logs
<span class="text-purple-400">WHERE</span> 
    action_taken = <span class="text-green-400">'BLOCKED'</span>
    <span class="text-purple-400">AND</span> status = <span class="text-green-400">'CONFIRMED_FRAUD'</span>
    <span class="text-purple-400">AND</span> date >= DATE_TRUNC(<span class="text-green-400">'month'</span>, CURRENT_DATE)
<span class="text-purple-400">GROUP BY</span> leakage_type;

<span class="text-gray-500">-- Output: </span>
<span class="text-gray-500">-- | 1,500,000 | 'Duplicate Invoice' |</span>
<span class="text-gray-500">-- |   850,000 | 'Maverick Buying'   |</span>
                </div>
            </div>
        </div>

    </main>

</body>
</html>